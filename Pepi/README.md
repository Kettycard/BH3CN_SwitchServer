# 「崩坏3」跨服教程（Pepi）（iOS 端 → 安卓国服）
 > By: [Mornwind](https://blog.mornwind.cc)
 > 
 > GitHub Link: [Mornwind/BH3CN_SwitchServer/Shadowrocket](https://github.com/Mornwind/BH3CN_SwitchServer/tree/master/Pepi)

## 参考来源
 > ① 霞ヶ丘詩羽x：[B站专栏（cv3610324）](https://www.bilibili.com/read/cv3610324)
 > 
 > ② FlintyLemming：[QuanX 跨服规则](https://git.flinty.moe/root/BH3_Region_Selector)

---

## ⚠️ 注意事项 ⚠️
1. **非官方直接提供的“跨服”行为，本身就违反了 Mihoyo 的用户协议。如若担心自己被封号，请勿使用本方法跨服，买对应的设备去玩更安全放心。**
2. 目前在 iOS 端登录安卓国服，仍无法进行充值，还需要自备安卓设备或者用 PC 端进行充值。
3. 本项目内所提到的所有客户端与服务器，均为**国服**。
4. 目前跨服**只可在官服之间进行**。渠道服由于**账号系统**不同以及游戏包体中的**登录器**不同，现阶段没有找到方法跨服，只能通过在 PC 端上扫码进行登录这种方式，敬请见谅。本项目中关于渠道服的部分，仅作学习参考，尚起不到实际用途。
5. **若出现资源缺失，需先进 iOS 国服下载资源。**

## ⚠️ 特别说明 ⚠️
1. 新建的节点为本机地址（可以自行谷歌一下“localhost”及“127.0.0.1”的用途），并非自建服务器。

---

## 效果预览
![使用 Pepi 跨服](/Pepi/Pepi_Preview.jpg)

---

## 前期准备
- 账号：安卓国服
- 系统：iOS 12+ / iPadOS 13+
- 工具：[Pepi](https://apps.apple.com/app/id1283082051)
- GitHub 项目链接：[Mornwind/BH3CN_SwitchServer/Pepi](/Pepi)

## 配置方法（重定向法）
 > 默认全平台列表（本身就是完整列表，由官方云端控制，只不过账号密码登录方式中隐藏了渠道服入口）。
 > 
 > 仅使用 **URL 重定向（URL Rewrite）** 功能实现。

### 方法一：直接下载简易跨服配置
 > 适合于：从未使用过 Pepi 的新用户；曾用过 Pepi 但目前没有上外网需求的老用户；折腾不来或不爱折腾的新、老用户。

1. **新建本机节点**：在首页，点击绿色圆按钮下方第一个项目“暂无节点”，进入“服务器节点”页面，点击“添加节点”，然后添加一个类型为“HTTP”（或“HTTPS”）、地址为“localhost”（或“127.0.0.1”）、端口为“1080”（或其它在 1-65535 之间的端口）的节点，然后在“服务器节点”页面。
2. **下载并应用简易跨服规则文件**：点击主页左上角三横线“☰”，进入“配置”→“规则文件”页面，点击“导入”中的“从 URL 下载”，在弹出的窗口中，输入下面的 URL 下载规则文件，然后在上方“规则文件”列表中点击选中刚刚下载的规则。

```
https://raw.githubusercontent.com/Mornwind/BH3CN_SwitchServer/master/Pepi/bh3cn_switchserver.conf
```

3. **安装 MitM 证书**：回到首页，点击主页左上角三横线“☰”，进入“设置”→“HTTPS”页面，点击“证书”中的“生成新的 CA 证书”，成功生成证书后，再点击“安装根证书”，允许下载配置描述文件，前往系统的“设置”→“通用”→“描述文件与设备管理”中安装该证书。
4. **信任 MitM 证书**：在系统的“设置”→“通用”→“关于本机”→“证书信任设置”中信任该证书；然后回到 Pepi 的“HTTPS”页面。
5. **配置 HTTPS 解密**：在“HTTPS”页面中，进入“域名”页面，在“添加主机名称”中添加一条 `*.bh3.com`，然后点击右上角“✓”，回到“HTTPS”页面，打开“解密 HTTPS 流量”开关，然后再点击右上角“✓”，然后回到首页。
6. **启动 Pepi**：在首页，点击中间绿色圆形按钮启动 Pepi，然后在清除了游戏后台的情况下进入游戏，即可实现跨服。（不玩游戏时，别忘了停止 Pepi。）

### 方法二：手动写入当前使用中配置
 > 适合于：目前仍在使用 Pepi 上外网的老用户；爱折腾的新、老用户。

1. **新建本机节点**：在首页，点击绿色圆按钮下方第一个项目“暂无节点”，进入“服务器节点”页面，点击“添加节点”，然后添加一个类型为“HTTP”（或“HTTPS”）、地址为“localhost”（或“127.0.0.1”）、端口为“1080”（或其它在 1-65535 之间的端口）的节点，然后在“服务器节点”页面。
2. **进入配置编辑界面**：点击主页左上角三横线“☰”，进入“配置”→“规则文件”页面，在“规则文件”中找到正在使用的规则文件，左划，点击“编辑”，进入配置编辑界面。
3. **添加跨服配置**：在弹出的编辑窗口中，将以下配置中 `[URL REWRITE]` 下方的代码，在配置文件中找到对应位置复制进去，然后点击右上角的“保存”。

```
[URL REWRITE]
# 崩坏3 跨服
# > 获取全平台服务器列表
^https:\/\/(.+?)\.bh3\.com\/query_dispatch\?version=(.+?)_gf_(.+?)&t=(\d+) https://$1.bh3.com/query_dispatch?version=$2_gf_pc HEADER
# > 改写连入服务器的客户端标识
# >> 安卓国服
^http:\/\/106\.14\.51\.73\/query_gameserver\?version=(.+?)_gf_(.+?)&t=(\d+)&uid=(\d+) http://106.14.51.73/query_gameserver?version=$1_gf_pc HEADER
# >> iOS国服
^http:\/\/139\.224\.7\.27\/query_gameserver\?version=(.+?)_gf_(.+?)&t=(\d+)&uid=(\d+) http://139.224.7.27/query_gameserver?version=$1_gf_pc HEADER
# >> 全平台（桌面）服
^http:\/\/106\.15\.162\.73\/query_gameserver\?version=(.+?)_gf_(.+?)&t=(\d+)&uid=(\d+) http://106.15.162.73/query_gameserver?version=$1_gf_pc HEADER
```

4. **安装 MitM 证书**：回到首页，点击主页左上角三横线“☰”，进入“设置”→“HTTPS”页面，点击“证书”中的“生成新的 CA 证书”，成功生成证书后，再点击“安装根证书”，允许下载配置描述文件，前往系统的“设置”→“通用”→“描述文件与设备管理”中安装该证书。
5. **信任 MitM 证书**：在系统的“设置”→“通用”→“关于本机”→“证书信任设置”中信任该证书，然后回到 Pepi 的“HTTPS”页面。
6. **配置 HTTPS 解密**：在“HTTPS”页面中，进入“域名”页面，在“添加主机名称”中添加一条 `*.bh3.com`，然后点击右上角“✓”，回到“HTTPS”页面，打开“解密 HTTPS 流量”开关，然后再点击右上角“✓”，然后回到首页。
7. **重启 Pepi**：在首页，点击中间绿色圆形按钮启动 Pepi，然后在清除了游戏后台的情况下进入游戏，即可实现跨服。
